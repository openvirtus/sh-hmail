#!/bin/sh -e
#h: Usage: $0 ...
#h:
#h: Mail retrieval configuration script.
#h:
#h: -i mbsync : Install `isync` IMAP mail downloader. Use `mbsync -a`
#h:             to `~/.mbsyncrc`.
#h: -i mu4e   : Install `mu` and `mu4e`.
#h: -c mu4e   : Configure GNU/Emacs mu4e email reader, for this lists
#h:             the accounts in `~/.msyncrc`.
. hutil
himap() {
    ## Parse command line arguments.
    local OPTIND optopt= ops= i= installs= c= configs=
    while getopts "vo:i:" optopt;do # OPTARG
        local ops="${ops}${optopt}"
        case $optopt in
            o)  local "${OPTARG}";;
            \?) return 1;;
        esac
    done
    shift $(( $OPTIND - 1 ))
    ## Operations.
    case "${ops}" in *v*) himap_show_variables;; esac
    for i in ${installs};do himap_install_"${i}";   done
    for c in ${configs}; do himap_configure_"${c}"; done
    
}
himap_show_variables() {
    printf '%-30s: %s\n' MAILDIR_DIRECTORY "${MAILDIR_DIRECTORY}"
    printf '%-30s: %s\n' MBSYNCRC          "${MBSYNCRC}"
    printf '%-30s: %s\n' EMACS_INIT        "${EMACS_INIT}"
    printf '%-30s: %s\n' IMAP_SERVER       "${IMAP_SERVER}"
    printf '%-30s: %s\n' IMAP_SSL_PORT     "${IMAP_SSL_PORT}"
    printf '%-30s: %s\n' IMAP_ACCOUNT      "${IMAP_ACCOUNT}"
    printf '%-30s: %s\n' IMAP_PASSWORD     "${IMAP_PASSWORD}"
}
himap_calc_variables() {
    MAILDIR_DIRECTORY="${MAILDIR_DIRECTORY:-${HOME}/MAIL}"
    MBSYNCRC="${MBSYNCRC:-${HOME}/.mbsyncrc}"
    EMACS_INIT="${EMACS_INIT:-${HOME}/.emacs.d/init.el}"
    IMAP_SERVER="${IMAP_SERVER:-}"
    IMAP_SSL_PORT="${IMAP_SSL_PORT:-993}"
    IMAP_ACCOUNT="{IMAP_ACCOUNT:-}"
    IMAP_PASSWORD="${IMAP_PASSWORD:-}"
}




## ------------------------------------------------------------------------
## ---- MBSYNC CONFIGURATION : LIST AND DELETE ACCOUNTS -------------------
## ------------------------------------------------------------------------
himap_mbsync_list_accounts() {
    if test -f "${MBSYNCRC}";then
        hutil flst "${MBSYNCRC}"
    fi
}
himap_mbsync_del_account() { # ACCOUNT
    local account="$1"
    hutil errif "Please specify an account name." test ! -n "${account}"
    echo "himap: Deleting ${1} from ${MBSYNCRC} ..." >&2
    hutil fdel "${MBSYNCRC}" "${1}"
}



## -------------------------------------------------------------------------
## ---- MBSYNC CONFIGURATION -----------------------------------------------
## -------------------------------------------------------------------------
himap_configure_mbsync() {
    hutil errif "Please specify IMAP_SERVER."   test ! -n "${IMAP_SERVER}"
    hutil errif "Please specify IMAP_SSL_PORT." test ! -n "${IMAP_SSL_PORT}"
    hutil errif "Please specify IMAP_ACCOUNT."  test ! -n "${IMAP_ACCOUNT}"
    hutil errif "Please specify IMAP_PASSWORD." test ! -n "${IMAP_PASSWORD}"
    local account="`echo "${IMAP_ACCOUNT}" | sed 's|[_\.-@]|_|g'`"
    mkdir -p "${MAILDIR_DIRECTORY}/${account}"
    hutil info "Editing ${MBSYNCRC} ..."
    hutil fadd "${MBSYNCRC}" "${account}" <<EOF

## ACCOUNT INFO FOR MAILSTORE1
IMAPAccount ${account}
Host ${IMAP_SERVER}
Port ${IMAP_SSL_PORT}
User ${IMAP_ACCOUNT}
Pass "${IMAP_PASSWORD}"
SSLType IMAPS
SSLVersions TLSv1.2
AuthMechs *
CertificateFile /etc/ssl/certs/ca-certificates.crt

## MAILSTORE1
IMAPStore ${account}-remote
Account   ${account}

## MAILSTORE2
MaildirStore ${account}-local
SubFolders   Verbatim
# The trailing "/" is important
Path  ${MAILDIR_DIRECTORY}/${account}/
Inbox ${MAILDIR_DIRECTORY}/${account}/Inbox/

## CHANNEL REMOTE -> LOCAL
Channel ${account}
Master :${account}-remote:
Slave  :${account}-local:
Patterns * ![Gmail]/Todos
Sync All
Create Both
SyncState *
EOF
}


himap_configure_mu4e() {
    if test -f "${EMACS_INIT}";then
        hemacs -P mu4e-maildirs-extension
        hutil fadd "${EMACS_INIT}" MU4E-INSTALL <<EOF
;; -- MU4E-INSTALL --
(require 'mu4e)
(require 'mu4e-maildirs-extension)
(mu4e-maildirs-extension)
(defun rmail () (interactive "") (mu4e))
(setq mail-user-agent 'mu4e-user-agent)
(setq mu4e-get-mail-command "mbsync -a")
(setq message-send-mail-function        'smtpmail-send-it
      user-full-name                    ""
      sendmail-program                  "/usr/bin/msmtp"
      send-mail-function                'smtpmail-send-it
      message-sendmail-f-is-evil        t
      message-sendmail-extra-arguments  '("--read-envelope-from")
      message-send-mail-function        'message-send-mail-with-sendmail)

(require 'mu4e-contrib)
(setq mu4e-html2text-command 'mu4e-shr2text)
(setq shr-color-visible-luminance-min 60)
(setq shr-color-visible-distance-min 5)
(setq shr-use-colors nil)
(setq mu4e-view-show-addresses 't)
(advice-add
    #'shr-colorize-region
    :around
    (defun shr-no-colourise-region (&rest ignore)))
;; -- MU4E-INSTALL --
EOF
        echo "himap: Updating ~/.emacs.d/init.el ..." >&2
        if test -d "${HIMAP_MAILDIR_DIRECTORY}";then
            echo "(setq mu4e-contexts"
            echo '  `('
            local num=1
            for account in `himap_mbsync_list_accounts`;do
                echo "   ,(make-mu4e-context"
                echo "       :name \"${num} - ${account}\""
                echo "       :vars '((mu4e-maildir      . \"${HIMAP_MAILDIR_DIRECTORY}\")"
                echo "               (user-mail-address . \"${account}\")))"
                local num=$(( $num + 1 ))
            done
            echo "  )"
            echo ")"
        fi | hutil fadd "${HOME}/.emacs.d/init.el" MU4E-ACCOUNTS ";;"    
    fi
    mu init -m "${HIMAP_MAILDIR_DIRECTORY}"
}








## --------------------------------------------------------------------------
## ---- INSTALL THE SOFTWARE ------------------------------------------------
## --------------------------------------------------------------------------
himap_install_mbsync() {
    hapt -skip "isync" -yum "isync" -apt "isync" -xbps "isync"
    hutil info "Creating /usr/local/bin/mbsyncd ..."
    hutil create sudo /usr/local/bin/mbsyncd <<EOF
#!/bin/sh -e
while true;do
    echo "Getting mail ..."
    touch ~/.mail-timestamp
    mbsync -a || true
    if which hvnc-notify >/dev/null 2>&1;then
        count=0
        for m in \`find ~/MAIL -iregex '.*/New/.*'\`;do
            if test "\$m" -nt ~/.mail-timestamp;then
               count=\$(( \$count + 1 )) 
            fi
        done
        if test ! \$count = 0;then
            hvnc-notify "You have \$count new mail."
        fi
    fi
    echo "Waiting 2 minutes ..."
    sleep $(( 60 + 5 ))
done
EOF
    sudo chmod +x /usr/local/bin/mbsyncd
    hutil daemon "mbsync" "/usr/local/bin/mbsyncd" "${USER}"
}
himap_install_mu4e() {
    if test -f "/etc/emacs/site-start.d/50mu4e.el" && test f "/usr/bin/mu";then
        true
    elif test -f /usr/bin/apt-get;then
        sudo apt-get -y install "mu" "mu4e"
    elif test -f /bin/xbps-install;then
        sudo xbps-install "mu" "mu4e"
    else
        hutil fatal "Do not know how to install 'mu' and 'mu4e'."
    fi
}
hsmtp_set_default_emacs() {
    hutil info "Setting ${SMTP_ACCOUNT} as default in ~/.emacs.d/init.el ..."
    echo "(setq user-mail-address \"${SMTP_ACCOUNT}\")" \
        | hutil fadd ~/.emacs.d/init.el MU4E-DEFAULT

}






## -----------------------------------------------------------------------------
himap_calc_variables
if test @"`basename "$0"`" = @"himap";then
    if test -n "$1";then
        himap "$@"
    else
        sed -n 's/^ *#h: \{0,1\}//p' "$0" | sed "s|\\\$0|`basename $0`|g"
        echo ""
        sed -n 's/^ *#l: \{0,2\}//p' "$0"
    fi
fi
